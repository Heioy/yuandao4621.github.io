#### `inode` 是什么？

要了解 Linux 操作系统上的 `inode` 前，我们先来说说 Linux操作系统上的文件。对于 Linux 操作系统而言，[一切皆文件]。而文件是无法独立于存储介质(这里指的是物理磁盘或内存、闪存等)存在的，一切操作系统上的文件都无时无刻不在和存储介质打交道。

例如，读取文件时需要将文件从磁盘中加载到内存中，当文件操作结束后，文件又会被存储到磁盘中。那么，既然文件要被存储到磁盘中，而磁盘是有容量限制的，那么也就是说磁盘上能存放的物理文件的数量是有限的。

如果你已经理解了这一个观点，那么恭喜你，你大体上已经知道了 `inode` 是干什么的。

没错，`inode` 是用来标识操作系统的文件的一个特征描述，而且操作系统上的 `inode` 并非无穷无尽，通常在你安装操作系统后，系统上的 `inode` 数量就已经确定了下来(不过，你可以动态修改 `inode` 的数量)。

你可以通过 `sysctl -a` 查询系统上的 `inode` 数量。

```bash
[root@server ~]# sysctl -a | grep inode
fs.inode-nr = 70212	21785
```

如上，`fs.inode-nr` 中的 70212 标识当前操作系统已分配的 `inode` 数量；21785 表示单前操作系统剩余空闲的 `inode` 数量

刚刚说过， `inode` 是用来标识文件的一个特征，这是为什么呢？

Linux 系统为每一个文件都分配了一个 `inode` 编号，这个编号中记录了文件相关的一些元信息，通过这些元信息可以用来唯一标识一个文件。

你可以通过 `ls -i` 查看任意一个文件的 `inode` 编号

```bash
[root@server ~]# ls -i logrotate.man
8986710 logrotate.man
```

而要查看文件的元信息，你需要使用 `stat {filename}`

```bash
[root@server ~]# stat logrotate.man
  文件："logrotate.man"
  大小：18033     	块：40         IO 块：4096   普通文件
设备：fd00h/64768d	Inode：8986710     硬链接：1
权限：(0644/-rw-r--r--)  Uid：(    0/    root)   Gid：(    0/    root)
环境：unconfined_u:object_r:admin_home_t:s0
最近访问：2021-11-25 03:20:39.497330998 -0500
最近更改：2021-11-24 04:38:17.781399647 -0500
最近改动：2021-11-24 04:38:17.797398907 -0500
创建时间：-
```

如上，即为一个文件的 `inode` 信息。这其中包含：

- `大小：18033`: 文件的字节数。这个文件占据的磁盘空间为 18033 Bytes
- `块：40`：使用的 `block(数据块)`。这个文件使用了 40 个物理块
- `权限：(0644/-rw-r--r--)  Uid：(    0/    root)   Gid：(    0/    root)`：文件的权限及属组信息。该文件为普通文件，权限为 0644，用户和属组都为 root
- `最近访问：2021-11-25 03:20:39.497330998 -0500`：即 `atime(最后一次访问该文件的时间)`
- `最近更改：2021-11-24 04:38:17.781399647 -0500`：即 `mtime(最后一次修改文件的时间)`
- `最近改动：2021-11-24 04:38:17.797398907 -0500`：即 `ctime(最后一次改变文件(权限、属组)的时间)`

事实上，刚刚通过 `stat logrotate.man` 中还包括一个字段 `硬链接：1`。

为什么硬链接会出现在 `inode` 信息中？

一般情况下，操作系统中一个文件对应一个 `inode` ，但是这种规则却不适用于 `硬链接` 文件。盖因Linux操作系统上，允许多个文件指向同一个 `inode` 编号。(参考自：[理解inode - 阮一峰的网络日志 (ruanyifeng.com)](https://ruanyifeng.com/blog/2011/12/inode.html))

硬链接场景下，可以使用不同的文件名访问同一个文件的内容，对文件内容、属性等的修改会传递到其他文件。但删除一个链接文件，并不影响其他文件的访问。

例如，建立 `logrotate.man` 的硬链接文件

```bash
[root@server ~]# ln logrotate.man logrotate.man.1
[root@server ~]# ls -i logrotate.man*
8986710 logrotate.man  8986710 logrotate.man.1
# 可以看到，建立了硬链接的文件共用了同一个 inode 编号
[root@server ~]# stat logrotate.man
  文件："logrotate.man"
  大小：18033     	块：40         IO 块：4096   普通文件
设备：fd00h/64768d	Inode：8986710     硬链接：2
权限：(0644/-rw-r--r--)  Uid：(    0/    root)   Gid：(    0/    root)
环境：unconfined_u:object_r:admin_home_t:s0
最近访问：2021-11-25 03:20:39.497330998 -0500
最近更改：2021-11-24 04:38:17.781399647 -0500
最近改动：2021-12-05 01:22:05.716611059 -0500
创建时间：-
```

建立硬链接后，通过 `stat` 可以看到 硬链接的数量变为 2 了。

这个时候我们删除原始的链接文件，查看链接后的文件内容

```bash
[root@server ~]# rm -rf logrotate.man
[root@server ~]# tail -n 1 logrotate.man.1
Linux                                                                                                                         Wed Nov 5 2002                                                                                                                 LOGROTATE(8)
[root@server ~]# stat logrotate.man.1
  文件："logrotate.man.1"
  大小：18033     	块：40         IO 块：4096   普通文件
设备：fd00h/64768d	Inode：8986710     硬链接：1
权限：(0644/-rw-r--r--)  Uid：(    0/    root)   Gid：(    0/    root)
环境：unconfined_u:object_r:admin_home_t:s0
最近访问：2021-12-05 01:25:50.701384256 -0500
最近更改：2021-11-24 04:38:17.781399647 -0500
最近改动：2021-12-05 01:25:41.544800473 -0500
创建时间：-
```

删除硬链接的原始文件后，可以成功读取链接后的文件内容，此时，硬链接数量又变为了 1。

出现这种情况的原因在于，硬链接实际上是对文件增加了一个索引，这个索引指向文件的 `inode` 编号。当硬链接的数量大于 1 时，说明该文件除去自身外，还有多个硬链接。当硬链接的数量等于 0 时，此时操作系统已经没有任何文件指向该 `inode`，也即是操作系统会回收 `inode`。

事实上，每删除一个文件，是对该文件硬链接数的「减一」操作。当文件的硬链接数归 0 时，这个文件会被操作系统彻底清除掉。

最后，通常情况下，操作系统分配的 `inode` 数量是完全够用的，但出于一些程序或人为的意外可能会导致操作系统的 `inode` 溢出，你可以通过 `df -ih` 查看系统分区下 `inode` 的使用情况以便及时作出应对措施。

```bash
[root@server ~]# df -ih
文件系统                Inode 已用(I) 可用(I) 已用(I)% 挂载点
devtmpfs                 121K     390    121K       1% /dev
tmpfs                    124K       1    124K       1% /dev/shm
tmpfs                    124K     522    124K       1% /run
tmpfs                    124K      16    124K       1% /sys/fs/cgroup
/dev/mapper/centos-root  4.0M    129K    3.9M       4% /
/dev/vda1                512K     332    512K       1% /boot
tmpfs                    124K       1    124K       1% /run/user/0
```



